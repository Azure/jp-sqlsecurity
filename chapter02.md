# 第２章 データ基盤でのセキュリティ要件
<hr style="height:1px; background-color:#c0c0c0;">

多層防御で重要データを守るために、データ基盤でも、データベースで提供される認証及びアクセス制御の機能を活用し適切に設定することでリスクを低減します。またデータをやりとりする通信に加えて、データの暗号化、マスキングにより、データを無害化することも可能です。

そして、防御をすり抜ける、あるいは、正当なアクセス権による正常とみなされる操作の中にあるリスクに対して、検知の対策を行うことが最重要です。

データ基盤、データベースにおけるセキュリティ要件をまとめます。


## 1. ネットワークの制御だけで十分か？ 求められる多層防御
セキュリティ対策の中でも、ネットワークの対策やエンドポイントでの対策に比べ、データ基盤、データベースにおける対策はあまり意識されないことが多く、後回しにされがちです。

侵入された場合は無防備であり、近年大きな問題となっている、標的型攻撃、ランサムウェアのような攻撃で、権限を奪取されデータ基盤まで侵入されるといったリスクが拡大しています。多層防御として、データ基盤、データベースでの対策を考えることが重要です。

<br>

![多層防御によるデータ セキュリティ](/assets/IMG003_DefenseInDepthForDataSecurity.svg)

<br>

 <table border="1">
    <tr>
      <th rowspan="2">データ基盤へのアクセスパターン</th>
      <th colspan="2">対応レイヤ</th>
    </tr>
    <tr>
          <th width="30%">ネットワーク</th>
          <th width="30%">データベース</th>
    </tr>
    <tr>
      <td>許可されていない DB へのアクセス</td>
      <td>構成（VNET, プライベート リンク）<br>FW<br>IPS・IDS</td>
      <td>ユーザー認証（AAD 認証／SQL 認証）</td>
    </tr>
    <tr>
      <td>DB 内アクセス範囲外へのアクセス</td>
      <td>ー</td>
      <td>DB でのアクセス制御設定<br>（ロール、オブジェクト、行、列）<br>マスキング</td>
    </tr>
    <tr>
      <td>アクセス権限は持っているが 許可されていないアクセス</td>
      <td>通信の暗号化</td>
      <td>データベースの暗号化</td>
    </tr>
    <tr>
      <td>正当な権限を使った不正アクセス</td>
      <td>ー</td>
      <td>DB 操作ログのモニタリング<br>フォレンジック</td>
    </tr>
 <table>

<br>



[「第１章 データ基盤におけるデータセキュリティの重要性」](/chapter01.md/#1-nist-csf（cyber-security-framework）コア機能と-azure-での対応)で紹介した防御対策の中で、「ネットワーク セキュリティ」で入り口での防御対策は第一歩であり、セキュリティの大前提です。

その上で、データ基盤までアクセスできる場合のリスクを考えた防御対策である、データ基盤のアクセス制御や暗号化に加えて、データ基盤でのふるまいをログとして記録しモニタリングすることは、最後の砦であり非常に重要であることを認識する必要があります。

防御対策は、アクセス情報を持っていない宛先に対する無差別なアクセスの試行、許可されていないデータ資源に対する攻撃の試行、といった、決められたアクセス元 IP／ホストからの決められたポートに対するアクセスのみ許可する、といったルール化が可能な試みをブロックすることが主な対応となります。

それらはほぼすべて、データ基盤に入る前にブロックされます。

それだけで大丈夫でしょうか？

これまでの事例や昨今の攻撃手法をみると、データ基盤までアクセスでき、そのことによって重大なセキュリティ インシデントになってしまうことがわかります。

データ基盤での対策は最後の砦ともいえるでしょう。

データ基盤での対策としては以下の2種類のユーザーに対しての制御が必要になります。

* データ基盤へのアクセスはできるが、アクセス範囲が限定され、アクセスできる範囲や方法が限られる　通常の DB ユーザー
* アクセス制限はなく重要データにもアクセスできる　管理者・特権ユーザー

また、防御では区別が困難で、検知の対策がより重要になってきます。

<br>

※防御対策の限界、課題

* 認証及びアクセス制御で防御できる範囲の限界
* 正常と判断されるものの中に潜む異常の判別
* 誤検知（異常と判断されてしまうこと）及び、切り分けの難しさ
* 特に、DB にログイン／アクセスできてしまう、権限ユーザーのなりすまし、その権限ユーザー自体の問題（内部リスク） 

<br>

![Database Security 全体像](/assets/IMG006_DatabaseSecuritOverview.svg)

<br><br>

<div style="margin:0em ;display:inline-block;position:relative;top:3px;padding:0 .5em;height:1.5em;line-height:1.5em;color:#ffffff;background:#bbb;font-weight:bold;text-align:center;border-radius:5px 5px 0 0;">Tips : データベース アクセスをセキュアに</div>
<div style="background: #fff; border: 1px #ccc solid; box-shadow: 0 2px 3px 0 #ddd; font-size: 100%; padding: 20px;">
<span style="color:#000000;font-weight:bold;">ネットワーク層でセキュアなデータベース アクセスを実現する 「Azure Private Link」</span>

<https://docs.microsoft.com/ja-jp/azure/private-link/private-link-overview>

Azure Private Link を使用し、仮想ネットワーク内の[プライベート エンドポイント](https://docs.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview)経由で Azure SQL Database など Azure でホストされているサービスにアクセスできます。

仮想ネットワークとサービスの間のトラフィックは、Microsoft のバックボーン ネットワークを通り、パブリック インターネットにサービスを公開する必要はないため、 セキュアでプライベートなアクセスを実現します。

![Azure Private Link](/assets/IMG007_AzurePrivateLink.svg)
</div>

<br><br>

## 2. データ基盤、データベースでのリスクとセキュリティのポイント

データ基盤、データベースでのリスクとセキュリティ対策のポイントを、具体例を元にご紹介します。

<br>

#### ◆ SQL インジェクション

昔から知られているデータベースでのリスクとして、SQL インジェクションがあります。

SQL インジェクションは基本的にはアプリケーションで問題のある SQL が生成されないよう、サニタイジングします。しかしながら、100% を求めることは難しいため、データベース層でもモニタリングしておくことも必要です。

セキュリティ インシデント事例
: Web サイトコンテンツ管理システム（CMS）で提供された、コメントフォームなどに対するスパムをブロックするプラグインに SQL インジェクションの脆弱性があった。
ユーザーエージェントをデータベースの独自テーブルに格納するため、ユーザーが SQL クエリを準備するなどが必要で、その SQL 処理にユーザーが意図しない SQL 文を紛れ込ませるというもの。この脆弱性を利用することは比較的容易で、記事を書き換えたり、意図しない投稿がされたり、データベースを削除する、といったことが可能だった。

<br>

#### ◆ アカウントとパスワードの漏えい、搾取

Web を介したサービスにおいては、顧客アカウントの搾取リスクは常に存在します。

アプリケーションを経由したアクセスでは、DB でのアクセス制御は正常と判断され、無意味です。データベースでの振る舞いで初めて異常と判断されることになります。

セキュリティ インシデント事例
: 広く公開される EC サイトで、ある日、大量の更新操作が記録され、データベースの更新ログ領域が爆発した。ユーザー アカウント・パスワードが奪取（広く知れ渡ったものでの辞書攻撃）されていて、当該アカウントによる大量の更新操作が行われたことによる被害だった。
購入行為ではなかったので、大きな問題にはならなかったが、アクセスしづらくなるなど、サービスへの影響が発生した。

<br>

#### ◆ 内部リスク

発生件数としては多くありませんが、内部リスクでの被害は非常に大きなものになることが多々あります。多層防御の視点において、権限をもったアクセス及び操作でのセキュリティ リスクへの対策は、データ基盤としては特に重要なものとなります。

内部からの過失や悪意によるものだけでなく、標的型攻撃による、権限を与えられているアカウントの奪取などによって、”内部”の操作におけるリスクが高まっています。

また、情報漏えいのみをターゲットにしがちですが、改ざんや破壊行為にも十分な注意を払う必要があります。

セキュリティ インシデント事例
: システム運用を委託するグループ会社の派遣エンジニアによって、直接データベースから顧客個人情報を大量に取得し、名簿業者に複数回に渡って売却された。
組織的な問題として個人情報へのアクセス権を申請承認して付与する仕組みはあったが、アクセス権限の見直しが行われていなかった。また内部不正を想定しておらず、管理体制が十分ではなかった。
個人情報を細分化などして、アクセス権を細かく設定したり、データ使用目的別にマスキングしたりするなどのデータベースでのアクセス制御も十分ではなかった。データベースのアクセス ログは取得していたが、定期的にモニタリングされることはなく、流出した個人情報が転売先で利用されたことによって発覚した。

<br>

データ基盤、データベースもクラウドへのシフトが進んでおり、クラウド サービスによって、レプリケーション、エクスポート、バックアップといった、データの保管やコピー、転送などの操作は、これまでより容易に実行することができるようになってきました。
クラウド データ基盤においては、こういった特性も踏まえて対策を実施する必要があることを付け加えたいと思います。

<br>

## 3. データ基盤、データベース セキュリティ セルフチェック

データベース セキュリティをセルフチェックしてみましょう。

 <table border="1" style="font-size: 10pt; line-height: 100%;">
    <tr>
      <th>項目</th>
      <th style="width: 8%; ">対応済み</th>
      <th style="width: 8%; ">一部対応</th>
      <th style="width: 8%; ">未対応</th>
      <th style="font-size:8pt; width: 8%; ">わからない</th>
    </tr>
    <tr><td colspan="5" style="background: #f8fcfc; "><strong>認証・アクセス制御</strong></td></tr>
    <tr><td>アカウントは、利用者別に、必要最小限の権限に限定して作成する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>不要なアカウントはすみやかに削除する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>特定業務だけに使用するようなアカウントは、通常時は利用できないようにロックする</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>一時的な利用の際には、その都度アカウント作成するか、パスワード設定を行って利用させるようにする</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>開発環境と本番環境で、アカウントやパスワードは分ける</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>強力な権限を持つ DB 管理者アカウントは、担当者別に割り当て、利用は必要最小限とどめる</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>パスワードは、複雑なパスワードにし、払い出されたパスワードの初回利用時に変更させる</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>DB 管理者アカウントに対しては、パスワードの定期的な変更や、有効期限を設定する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>ログインに連続して失敗した場合にはアカウントロックするなど対策する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>アカウントは定期的に棚卸し、権限を含めて見直しをする</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>アクセス権を付与できるアカウントは限定する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td colspan="5" style="background: #f8fcfc; "><strong>データ保護</strong></td></tr>
    <tr><td>DB とクライアント間の通信は暗号化する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>DB 格納データを暗号化する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>エクスポート、スナップショットなど、バックアップデータを暗号化する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td colspan="5" style="background: #f8fcfc; "><strong>検知・ログ モニタリング</strong></td></tr>
    <tr><td>インシデント調査／追跡を可能にするため、適切な内容のログを取得する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>必要な場合に利用できるよう、取得したログを適切に保全する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>不正アクセスやその試行を早期に検知する仕組みを設ける</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>不正アクセスの原因究明や、不正行為を検出するため、ログを分析する仕組みを設ける</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td colspan="5" style="background: #f8fcfc; "><strong>環境及び運用</strong></td></tr>
    <tr><td>DB にアクセス可能な端末あるいはセグメントを限定し、不特定多数の端末から直接アクセスできないようにする。<br>また DB にアクセスするアプリケーションの配布範囲を限定する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>最新の脅威を踏まえて、システム稼働前、及び定期的にセキュリティ診断を実施する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>DB 構成ファイル、定義スクリプトへのアクセスを制限し、定期的に権限見直しを実施する</td><td> </td><td> </td><td> </td><td> </td></tr>
    <tr><td>稼動するプログラムは改ざんがなされないようチェック、およびテストを実施する</td><td> </td><td> </td><td> </td><td> </td></tr>
 </table>

<br>


